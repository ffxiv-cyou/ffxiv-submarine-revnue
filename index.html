<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>潜艇收益计算器</title>
    <script type="module" crossorigin>var z=Object.defineProperty;var W=(n,e,t)=>e in n?z(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var r=(n,e,t)=>W(n,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=t(i);fetch(i.href,a)}})();var J=Object.defineProperty,Q=(n,e,t)=>e in n?J(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,c=(n,e,t)=>Q(n,typeof e!="symbol"?e+"":e,t);function G(n){return new K(n)}class K extends EventTarget{constructor(e){super(),c(this,"onconnect",null),c(this,"ondisconnect",null),c(this,"devices",new Map),this.api=e,this.addListener()}dispatchEvent(e){return e.type==="connect"&&this.onconnect&&this.onconnect.call(this,e),e.type==="disconnect"&&this.ondisconnect&&this.ondisconnect.call(this,e),super.dispatchEvent(e),!e.defaultPrevented}async getDevices(){const e=await this.requestGetDevices();let t=[];return e.forEach(s=>{if(this.devices.has(s.instanceId))t.push(this.devices.get(s.instanceId));else{const i=new P(this.api,s);this.devices.set(s.instanceId,i),t.push(i)}}),t}async requestDevice(e){return e&&console.log("Requesting device with options:",e),this.getDevices()}async requestGetDevices(){return(await O(this.api,"getDevices",{})).devices}addListener(){this.api.addOverlayListener("otk::hid::inputreport",e=>this.callbackInputReport(e)),this.api.addOverlayListener("otk::hid::devicechanged",e=>this.callbackDeviceChanged(e))}callbackInputReport(e){const t=e.instanceId,s=N(e.data),i=this.devices.get(t);i?i.dispatchEvent(new Y("inputreport",i,s[0],new DataView(s.buffer,1))):console.warn("Device not found:",t)}callbackDeviceChanged(e){var t=e.add;const s=new P(this.api,e.device),i=new X(t?"connect":"disconnect",s);this.dispatchEvent(i)}}async function O(n,e,t){const s={call:"otk::hid",type:e,...t},i=await n.callOverlayHandler(s);return i.error&&console.log("callOverlayHID error:",e,t,i),i}class P extends EventTarget{constructor(e,t){super(),c(this,"instanceId"),c(this,"opened",!1),c(this,"vendorId"),c(this,"productId"),c(this,"productName"),c(this,"collections"),c(this,"oninputreport",null),this.api=e,this.instanceId=t.instanceId,this.vendorId=t.vendorId,this.productId=t.productId,this.productName=t.productName,this.collections=t.collections||[]}dispatchEvent(e){return e.type==="inputreport"&&this.oninputreport&&this.oninputreport.call(this,e),super.dispatchEvent(e),!e.defaultPrevented}async open(){this.opened||(await this.request("open",{}),this.opened=!0)}async close(){this.opened&&(await this.request("close",{}),this.opened=!1)}async forget(){}async sendReport(e,t){if(!this.opened)throw new Error("Device is not opened.");await this.request("send",{reportId:e,data:T(t)})}async sendFeatureReport(e,t){if(!this.opened)throw new Error("Device is not opened.");await this.request("sendFeature",{reportId:e,data:T(t)})}async receiveFeatureReport(e){if(!this.opened)throw new Error("Device is not opened.");const t=await this.request("recvFeature",{reportId:e}),s=N(t.data);return new DataView(s.buffer)}async request(e,t){return O(this.api,e,{instanceId:this.instanceId,...t})}}class X extends Event{constructor(e,t){super(e),c(this,"device"),this.device=t}}class Y extends Event{constructor(e,t,s,i){super(e),c(this,"device"),c(this,"reportId"),c(this,"data"),this.device=t,this.reportId=s,this.data=i}}function T(n){let e=null;return n instanceof ArrayBuffer?e=new Uint8Array(n):e=new Uint8Array(n.buffer,n.byteOffset,n.byteLength),[...e].map(t=>t.toString(16).padStart(2,"0")).join("")}function N(n){const e=new Uint8Array(Math.ceil(n.length/2));for(let t=0;t<n.length;)e[t/2]=Number.parseInt(n.slice(t,t+=2),16);return e}class Z{constructor(e=null){c(this,"subscribers",new Map),c(this,"queue",[]),this.transport=e,e&&this.setTransport(e)}setTransport(e){this.transport=e,this.transport.addEventListener("message",t=>{this.dispatchOverlayEvent(t.detail)}),this.transport.addEventListener("connected",this.onTransportConnected.bind(this))}dispatchOverlayEvent(e){const t=this.subscribers.get(e.type);if(t)for(const s of t)s(e)}addOverlayListener(e,t){this.subscribers.has(e)||this.subscribers.set(e,[]),this.subscribers.get(e).push(t)}removeOverlayListener(e,t){if(!this.subscribers.has(e))return;const s=this.subscribers.get(e),i=s.indexOf(t);i!==-1&&s.splice(i,1)}async callOverlayHandler(e){return!this.transport||!this.transport.connected?(console.warn("OverlayPluginAPI: Transport not connected, queuing message",e),new Promise(t=>{this.queue.push([e,t])})):this.transport.sendMessage(e)}startOverlayEvents(){var e={call:"subscribe",events:Array.from(this.subscribers.keys())};this.callOverlayHandler(e)}onTransportConnected(){if(!this.transport||!this.transport.connected||this.queue.length===0)return;console.log("OverlayPluginAPI: Transport connected, sending queued messages");let e=this.queue;this.queue=[];for(let[t,s]of e)this.transport.sendMessage(t).then(s)}}class $ extends EventTarget{constructor(){super(...arguments),c(this,"connected",!1),c(this,"evtHandlerWrapper",e=>{this.dispatchEvent(new CustomEvent("message",{detail:e}))})}get transportType(){return"plugin"}sendMessage(e){return new Promise(t=>{window.OverlayPluginApi.callHandler(JSON.stringify(e),t)})}waitForApi(){if(!window.OverlayPluginApi||!window.OverlayPluginApi.ready){setTimeout(()=>this.waitForApi(),300);return}window.__OverlayCallback=this.evtHandlerWrapper,this.connected=!0,this.dispatchEvent(new Event("connected"))}}class ee extends EventTarget{constructor(e){super(),c(this,"ws"),c(this,"sequence",0),c(this,"responseResolvers",new Map),c(this,"evtHandler",()=>{}),c(this,"connected",!1),this.ws=new WebSocket(e),this.connect(this.ws)}connect(e){e.addEventListener("open",this.onOpen.bind(this)),e.addEventListener("error",this.onError.bind(this)),e.addEventListener("message",this.onMessage.bind(this)),e.addEventListener("close",this.onClosed.bind(this))}onError(e){console.error(e)}onOpen(){console.log("WebSocket connected"),this.connected=!0,this.dispatchEvent(new Event("connected"))}onMessage(e){try{const t=JSON.parse(e.data);if("rseq"in t){const s=t.rseq;this.responseResolvers.has(s)&&(this.responseResolvers.get(s)(t),this.responseResolvers.delete(s))}else this.dispatchEvent(new CustomEvent("message",{detail:t}))}catch{console.error("Failed to parse WebSocket message",e)}}onClosed(e){console.log("WebSocket closed",e),this.connected=!1,setTimeout(()=>{console.log("WebSocket reconnecting..."),this.ws=new WebSocket(this.ws.url),this.connect(this.ws)},3e3)}get transportType(){return"websocket"}sendMessage(e){const t=this.sequence++;return e.rseq=t,new Promise(s=>{this.responseResolvers.set(t,s),this.ws.send(JSON.stringify(e))})}set eventHandler(e){this.evtHandler=e}}class te{constructor(){c(this,"hid"),c(this,"api",new Z),c(this,"handlerMap",new Map),this.hid=G(this.api)}Fetch(e,t={}){const s={call:"Fetch",resource:e,options:t};return this.api.callOverlayHandler(s)}async SubscribePacket(e,t,s){const i={call:"otk::packet",action:"subscribe",name:e,evt_name:"otk::packet::"+e,filters:t},a=await this.api.callOverlayHandler(i);if(a.error)throw new Error(a.error);return a.evt_name?(this.api.addOverlayListener(a.evt_name,o=>this.packetHandler(o,!1)),this.api.startOverlayEvents()):console.warn("plugin does not support evt_name for packet subscription, may < 0.4.0"),this.handlerMap.set(a.name||e,{handler:s,evt_name:a.evt_name}),a.name||e}async UnsubscribePacket(e){const t={call:"otk::packet",action:"unsubscribe",name:e},s=await this.api.callOverlayHandler(t);if(s.error)throw new Error(s.error);this.handlerMap.delete(e)}packetHandler(e,t=!1){let s=e,i=e;i.data=Uint8Array.from(atob(s.msg),o=>o.charCodeAt(0));let a=this.handlerMap.get(s.name);if(a){if(t&&a.evt_name)return;a.handler(i)}else t||console.warn("No packet handler for name",s.name)}async GetGameVersion(){const e={call:"otk::game_ver"};return this.api.callOverlayHandler(e)}async GetPluginVersion(){const e={call:"otk::plugin_ver"};return(await this.api.callOverlayHandler(e)).version}Start(){this.api.addOverlayListener("otk::packet",e=>this.packetHandler(e,!0)),this.api.startOverlayEvents()}Dispatch(e){this.api.dispatchOverlayEvent(e)}AddListener(e,t){this.api.addOverlayListener(e,t)}RemoveListener(e,t){this.api.removeOverlayListener(e,t)}Call(e){return this.api.callOverlayHandler(e)}IsOverlayPluginCEF(){return"OverlayPluginApi"in window}tryConnectToCEF(){if(!this.IsOverlayPluginCEF()){setTimeout(()=>this.tryConnectToCEF(),300);return}const e=new $;this.api.setTransport(e),e.waitForApi()}Connect(e=""){if(this.tryConnectToCEF(),e||(e=new URLSearchParams(location.search).get("OVERLAY_WS")),e){if(this.IsOverlayPluginCEF()){console.warn("OverlayToolkit: Connect wsUrl ignored in OverlayPlugin CEF environment");return}const t=new ee(e);this.api.setTransport(t)}}}let g=new te;(function(){g.Connect()})();class se{constructor(e){r(this,"array");r(this,"capacity");r(this,"_front");r(this,"_back");r(this,"_full");this.array=[],this.capacity=e,this._front=0,this._back=0,this._full=!1}push_back(e){this.array.length<this.capacity?this.array.push(e):this.array[this._back]=e,this._back=(this._back+1)%this.capacity,this._full&&(this._front=this._back),this._back==this._front&&(this._full=!0)}front(){if(!(this._front==this._back&&!this._full))return this.array[this._front]}pop_front(){if(!(this._front==this._back&&!this._full)){var e=this.array[this._front];return this._front=(this._front+1)%this.capacity,this._full&&(this._full=!1),e}}empty(){return!this._full&&this._front===this._back}}class ne{constructor(e,t){r(this,"itemID");r(this,"amount");r(this,"date");this.itemID=e,this.amount=t,this.date=Date.now()}}class ie{constructor(e){r(this,"buffer");r(this,"callback");this.buffer=new se(100),this.callback=e}init(e){e.AddListener("LogLine",t=>{this.parseLogLines(t.line)})}parseLogLines(e){if(!(e.length<1))switch(e[0]){case"00":this.parseLogLine(e[2],e[3],e[4]);break;case"41":this.parseSystemLogMessage(e[2],e[3],e[4],e[5],e[6]);break}}parseLogLine(e,t,s){if(!(e!=="0039"&&t!=="")){var i=/接受了“(.+)”探索完成的报告。/g,a=i.exec(s);if(!(!a||a.length<1)){var o=a[1];this.queueCleanup(Date.now()),setTimeout(()=>{this.setShipName(o)},1e3)}}}parseSystemLogMessage(e,t,s,i,a){if(t==="2EF"){var o=parseInt(i,16),h=parseInt(a,16);this.enqueueItem(o,h)}}setShipName(e){for(var t=new Map;!this.buffer.empty();){var s=this.buffer.front();if(this.buffer.pop_front(),!!s){var i=s.itemID,a=s.amount;if(t.has(i)){var o=t.get(i);o!=null&&(a+=o)}t.set(i,a)}}let h=[];t.forEach((v,R)=>{var j={id:R%1e6,hq:R>=1e6,amount:v};h.push(j)}),this.callback&&this.callback(e,h)}enqueueItem(e,t){var s=new ne(e,t);this.queueCleanup(s.date),this.buffer.push_back(s)}queueCleanup(e){for(;!this.buffer.empty();){var t=this.buffer.front();if(!t)break;if(e-t.date>5e3)this.buffer.pop_front();else break}}}const L=[{Id:22500,Name:"沉船戒指",PriceLow:8e3,PriceMid:3e4},{Id:22501,Name:"沉船手镯",PriceLow:9e3,PriceMid:3e4},{Id:22502,Name:"沉船耳饰",PriceLow:1e4,PriceMid:3e4},{Id:22503,Name:"沉船项链",PriceLow:13e3,PriceMid:3e4},{Id:22504,Name:"上等沉船戒指",PriceLow:27e3,PriceMid:9e4},{Id:22505,Name:"上等沉船手镯",PriceLow:28500,PriceMid:9e4},{Id:22506,Name:"上等沉船耳饰",PriceLow:3e4,PriceMid:9e4},{Id:22507,Name:"上等沉船项链",PriceLow:34500,PriceMid:9e4}];class re{constructor(e=null){r(this,"itemMap");r(this,"mapData",null);e===null&&(e=L),this.itemMap=new Map,e.forEach(t=>{this.itemMap.set(t.Id,t)}),fetch("data/item.json").then(t=>t.json()).then(t=>{t.forEach(s=>{this.itemMap.set(s.Id,s)}),console.log("Loaded item data",t.length)}),fetch("data/map.json").then(t=>t.json()).then(t=>{this.mapData=t,console.log("Loaded map data",t)})}getItemInfo(e){return this.itemMap.get(e)}name(e){const t=this.itemMap.get(e);return t?t.Name:e.toString()}price(e){const t=this.itemMap.get(e);return t?t.PriceLow:0}isBuiltinItem(e){return L.find(s=>s.Id===e)!==void 0}getRating(e){switch(e){case 0:return"SS";case 1:return"S";case 2:return"A";case 3:return"B";case 4:return"C";default:return e.toString()}}getDest(e){if(this.mapData===null)return null;const t=this.mapData.explorations.find(s=>s.id===e);return t||null}getDestName(e){const t=this.getDest(e);return t?t.name:e.toString()}getDestMapName(e){if(this.mapData===null)return e.toString();const t=this.getDest(e);return t?this.mapData.maps[t.mapId]||t.mapId.toString():e.toString()}getPartName(e){const t=Math.floor((e-1)/4)+1;return t<=5?t.toString():t<=10?(t-5).toString()+"改":e.toString()}}const u=new re;class x{constructor(e,t){r(this,"webhook");r(this,"token");r(this,"url","https://api.ffxiv.cyou/submarine/upload");this.webhook=e,this.token=t}setUrlToken(e,t){this.webhook=e,this.token=t}async postKdocsRaw(e){const t=await g.Fetch(this.webhook,{method:"POST",headers:{"Content-Type":"application/json","AirScript-Token":this.token},body:JSON.stringify({Context:{argv:e}})}),s=t.body;if(t.ok)return JSON.parse(s);try{const i=JSON.parse(s);throw new Error(i.error||i.msg||i.reason||i.result||s)}catch{throw new Error(s)}}async kdocsInsertRows(e){const t={data:e.map(s=>({fields:s.ToRow()}))};return this.postKdocsRaw(t)}async kdocsUploadV1(e,t){const s=t.filter(i=>u.isBuiltinItem(i.id)).map(i=>new _(e,i));return this.kdocsInsertRows(s)}async kdocsUploadV1Ex(e){const t=e.items.filter(s=>u.isBuiltinItem(s.id)).map(s=>new _(e.name,s));return this.kdocsInsertRows(t)}async kdocsUploadV2(e){const t=e.items.map(s=>new ae(e,s));return this.kdocsInsertRows(t)}async analysisUploadV2(e){const t=e,s=e.registerTime+"_"+e.returnTime+"_"+e.name,a=new TextEncoder().encode(s),o=await new SubtleCrypto().digest("SHA-1",a),h=Array.from(new Uint8Array(o)).map(v=>v.toString(16).padStart(2,"0")).join("");return t.digest=h,t.name="",t.registerTime=0,t.returnTime=0,fetch(this.url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}}class _{constructor(e,t){r(this,"id");r(this,"amount");r(this,"hq");r(this,"ship");this.id=t.id,this.amount=t.amount,this.hq=t.hq,this.ship=e}ToRow(){const e=u.name(this.id),t=u.price(this.id);return{潜艇名:this.ship,物品名:e,数量:this.amount,单价:t,总价:t*this.amount}}}class ae{constructor(e,t){r(this,"id");r(this,"amount");r(this,"hq");r(this,"surveillance");r(this,"retrieval");r(this,"discoveryDesc");r(this,"doubleDip");r(this,"isSecondDip");r(this,"fromTier3Pool");r(this,"destId");r(this,"rating");r(this,"ship");r(this,"returnTime");r(this,"dests");r(this,"parts");r(this,"rank");this.id=t.id,this.amount=t.amount,this.hq=t.hq,this.surveillance=t.surveillance,this.retrieval=t.retrieval,this.discoveryDesc=t.discoveryDesc,this.doubleDip=t.doubleDip,this.isSecondDip=t.isSecondDip,this.fromTier3Pool=t.fromTier3Pool,this.destId=t.destId,this.rating=t.rating,this.ship=e.name,this.returnTime=e.returnTime,this.dests=e.dests,this.parts=e.parts,this.rank=e.rank}ToRow(){const e=u.name(this.id),t=u.price(this.id),s=this.parts.map(i=>u.getPartName(i));return{潜艇名:this.ship,航线:this.dests.map(i=>u.getDestName(i)).join(""),等级:this.rank,部件:s.join(""),地图名:u.getDestMapName(this.destId),目的地:u.getDestName(this.destId),物品名:e,数量:this.amount,单价:t,总价:t*this.amount,探索情况:7-this.surveillance,收集情况:this.retrieval,收集描述:this.discoveryDesc,恩惠状态:this.doubleDip,恩惠产物:this.isSecondDip,高级产物:this.fromTier3Pool,评分:u.getRating(this.rating),时间:new Date(this.returnTime*1e3).toLocaleString("zh-CN",{hour12:!1})}}}const C="ship_config",y={webhook:"",token:"",revision:1,consent_analysis:!0};function q(){var n=localStorage.getItem(C);if(n===null)return y;try{const e=JSON.parse(n),t=y;return e.webhook&&typeof e.webhook=="string"&&(t.webhook=e.webhook),e.token&&typeof e.token=="string"&&(t.token=e.token),e.revision&&typeof e.revision=="number"&&(t.revision=e.revision),e.consent_analysis&&typeof e.consent_analysis=="boolean"&&(t.consent_analysis=e.consent_analysis),t}catch{return y}}function oe(n){localStorage.setItem(C,JSON.stringify(n))}class f{constructor(e,t=0){r(this,"size");r(this,"sourceActor");r(this,"targetActor");r(this,"type");this.size=e.getUint16(t,!0),this.sourceActor=e.getUint32(t+4,!0),this.targetActor=e.getUint32(t+8,!0),this.type=e.getUint16(t+12,!0)}static PacketSize(){return 16}}class p extends f{constructor(t,s=0){super(t,s);r(this,"opcode");r(this,"serverId");r(this,"timestamp");s+=f.PacketSize(),this.opcode=t.getUint16(s+2,!0),this.serverId=t.getUint32(s+4,!0),this.timestamp=t.getUint32(s+8,!0)}static PacketSize(){return f.PacketSize()+16}}class ce extends p{constructor(t,s=0){super(t,s);r(this,"category");r(this,"padding");r(this,"param1");r(this,"param2");r(this,"param3");r(this,"param4");r(this,"param5");r(this,"param6");r(this,"padding1");s+=p.PacketSize(),this.category=t.getUint16(s+0,!0),this.padding=t.getUint16(s+2,!0),this.param1=t.getUint32(s+4,!0),this.param2=t.getUint32(s+8,!0),this.param3=t.getUint32(s+12,!0),this.param4=t.getUint32(s+16,!0),this.param5=t.getUint32(s+20,!0),this.param6=t.getUint32(s+24,!0),this.padding1=t.getUint32(s+28,!0)}}class le extends p{constructor(t,s=0){super(t,s);r(this,"items",[]);s+=p.PacketSize();for(let i=0;i<4;i++)this.items.push(new ue(t,s+i*60))}}class ue{constructor(e,t){r(this,"status");r(this,"rank");r(this,"registerTime");r(this,"returnTime");r(this,"currentExp");r(this,"totalExpForNextRank");r(this,"capacity");r(this,"name");r(this,"hull");r(this,"stern");r(this,"bow");r(this,"bridge");r(this,"dests");this.status=e.getUint16(t+0,!0),this.rank=e.getUint16(t+2,!0),this.registerTime=e.getUint32(t+4,!0),this.returnTime=e.getUint32(t+8,!0),this.currentExp=e.getUint32(t+12,!0),this.totalExpForNextRank=e.getUint32(t+16,!0),this.capacity=e.getUint16(t+20,!0);const s=new TextDecoder("utf-8");let i=0;for(let o=0;o<24;o++)if(e.getUint8(t+22+o)==0){i=o;break}const a=new Uint8Array(e.buffer,e.byteOffset+t+22,i);this.name=s.decode(a),this.hull=e.getUint16(t+46,!0),this.stern=e.getUint16(t+48,!0),this.bow=e.getUint16(t+50,!0),this.bridge=e.getUint16(t+52,!0),this.dests=[];for(let o=0;o<5;o++){const h=e.getUint8(t+54+o);if(h!=0)this.dests.push(h);else break}}}class he extends p{constructor(t,s=0){super(t,s);r(this,"rating");r(this,"marineSpeed");r(this,"items",[]);s+=p.PacketSize(),this.rating=t.getUint16(s+0,!0),this.marineSpeed=t.getUint16(s+2,!0);for(let i=0;i<5;i++){const a=new de(t,s+4+i*56);a.destId!==0&&this.items.push(a)}}}class de{constructor(e,t){r(this,"destId");r(this,"rating");r(this,"unlockId");r(this,"firstTimeExploration");r(this,"unlockedSubmarineSlot");r(this,"doubleDip");r(this,"unknown0");r(this,"favorResult");r(this,"exp");r(this,"item1Id");r(this,"item2Id");r(this,"item1Quantity");r(this,"item2Quantity");r(this,"item1IsHq");r(this,"item2IsHq");r(this,"item1IsNormal");r(this,"item2IsNormal");r(this,"loot1SurveillanceResult");r(this,"loot2SurveillanceResult");r(this,"loot1RetrievalResult");r(this,"loot2RetrievalResult");r(this,"loot1ItemDiscoveryDescription");r(this,"loot2ItemDiscoveryDescription");this.destId=e.getUint8(t+0),this.rating=e.getUint8(t+1),this.unlockId=e.getUint8(t+2),this.firstTimeExploration=e.getUint8(t+3)!=0,this.unlockedSubmarineSlot=e.getUint8(t+4)!=0,this.doubleDip=e.getUint8(t+5)!=0,this.unknown0=e.getUint16(t+6,!0),this.favorResult=e.getUint32(t+8,!0),this.exp=e.getUint32(t+12,!0),this.item1Id=e.getUint32(t+16,!0),this.item2Id=e.getUint32(t+20,!0),this.item1Quantity=e.getUint16(t+24,!0),this.item2Quantity=e.getUint16(t+26,!0),this.item1IsHq=e.getUint8(t+28)!=0,this.item2IsHq=e.getUint8(t+29)!=0,this.item1IsNormal=e.getUint8(t+30),this.item2IsNormal=e.getUint8(t+31),this.loot1SurveillanceResult=e.getUint32(t+32,!0),this.loot2SurveillanceResult=e.getUint32(t+36,!0),this.loot1RetrievalResult=e.getUint32(t+40,!0),this.loot2RetrievalResult=e.getUint32(t+44,!0),this.loot1ItemDiscoveryDescription=e.getUint32(t+48,!0),this.loot2ItemDiscoveryDescription=e.getUint32(t+52,!0)}}var b=(n=>(n[n.SubmarineExplorationResult=0]="SubmarineExplorationResult",n[n.SubmarineStatusList=1]="SubmarineStatusList",n[n.ActorControlSelf=2]="ActorControlSelf",n))(b||{});const pe={2:!1,0:!1,1:!1};class me{constructor(e){r(this,"callback");r(this,"opcodeMap",new Map);r(this,"currentId",0);r(this,"ships",[]);r(this,"results",[]);this.callback=e}async init(e){const s=await(await fetch("/data/opcode.json")).json();Object.keys(b).forEach(i=>{if(!isNaN(Number(i)))return;const a=b[i];this.opcodeMap.set(s[i],a)}),await e.SubscribePacket("SubmarineRevnue",this.genPacketFilter(),this.parse.bind(this))}genPacketFilter(){const e=[];return this.opcodeMap.forEach((t,s)=>{e.push({opcode:s,direction:pe[t]})}),e}parse(e){const t=new DataView(e.data.buffer,e.data.byteOffset,e.data.byteLength);switch(this.opcodeMap.get(e.opcode)){case 0:{const i=new he(t);this.handleExplorationResult(i),console.log("Submarine Exploration Result:",i);break}case 1:{const i=new le(t);this.handleShipStatusList(i),console.log("Submarine Status List:",i);break}case 2:{const i=new ce(t);switch(i.category){case 1076:this.currentId=i.param1;break;case 1077:this.currentId!==i.param1&&console.warn("Mismatched submarine ID on close:",i.param1,"expected:",this.currentId),this.currentId=-1;break}break}}}getCurrentShip(){return this.currentId<0||this.currentId>=this.ships.length?null:this.ships[this.currentId]}handleExplorationResult(e){const t=this.getCurrentShip();if(!t){console.warn("No current ship for exploration result");return}this.results[this.currentId]=e,console.log("Exploration result for ship:",t,"result:",e)}handleShipStatusList(e){for(let t=0;t<e.items.length;t++){const s=e.items[t],i=this.ships[t];s.status===1&&(i&&i.status!==2||this.handleShipReturnedResult(t))}this.ships=e.items}handleShipReturnedResult(e){const t=this.ships[e],s=this.results[e];if(!t||!s){console.warn("No ship or result for returned ship at index:",e);return}const i=ge(t,s);this.callback(i)}}function ge(n,e){const t=[];for(const s of e.items){const i=ve(s);t.push(...i)}return{registerTime:n.registerTime,returnTime:n.returnTime,name:n.name,rank:n.rank,dests:n.dests,rating:e.rating,parts:[n.hull,n.stern,n.bow,n.bridge],items:t}}function ve(n){const e=[],t={doubleDip:n.doubleDip,isSecondDip:!1,fromTier3Pool:n.item2IsNormal===0,id:n.item1Id,amount:n.item1Quantity,hq:n.item1IsHq,surveillance:n.loot1SurveillanceResult,retrieval:n.loot1RetrievalResult,discoveryDesc:n.favorResult,destId:n.destId,rating:n.rating};if(e.push(t),n.doubleDip){const s={doubleDip:n.doubleDip,isSecondDip:!0,fromTier3Pool:n.item2IsNormal===0,id:n.item2Id,amount:n.item2Quantity,hq:n.item2IsHq,surveillance:n.loot2SurveillanceResult,retrieval:n.loot2RetrievalResult,discoveryDesc:n.favorResult,destId:n.destId,rating:n.rating};e.push(s)}return e}var l=q(),k=0,M=!1;const d=new x(l.webhook,l.token),ye=new ie(be),fe=new me(ke);function be(n,e){e.length===0||M||(A(n,e),l.webhook&&l.token&&(d.setUrlToken(l.webhook,l.token),m(w,d.kdocsUploadV1(n,e))))}function ke(n){n.items.length!==0&&(A(n.name,n.items),l.webhook&&l.token&&(d.setUrlToken(l.webhook,l.token),l.revision===1?m(w,d.kdocsUploadV1(n.name,n.items)):m(w,d.kdocsUploadV2(n))),l.consent_analysis&&d.analysisUploadV2(n).catch(e=>{console.error("上传分析数据失败:",e)}))}function A(n,e){var t=document.createElement("div");I.appendChild(t);var s=0;e.forEach(i=>{if(u.isBuiltinItem(i.id)){var a=u.getItemInfo(i.id);if(a!==void 0){var o=document.createElement("div");o.innerText=a.Name+" ×"+i.amount,I.appendChild(o),s+=a.PriceLow*i.amount}}}),t.innerText=n+": "+s.toString(),k+=s,Ie.innerText=k.toString(),F.classList.remove("hide")}document.getElementById("close").onclick=n=>{F.classList.add("hide"),I.innerText="",k=0,n.preventDefault()};var I=document.getElementById("item-list"),Ie=document.getElementById("total-value"),F=document.getElementById("app"),H=document.getElementById("config"),w=document.getElementById("output"),E=document.getElementById("webhook"),D=document.getElementById("token"),S=document.getElementById("test-output"),B=document.getElementById("consent_analysis"),U=document.getElementById("revision-1"),V=document.getElementById("revision-2");document.getElementById("test-cfg").onclick=n=>{const e=new x(E.value,D.value);if(U.checked){const t=e.kdocsUploadV1("测试用数据",[{id:22500,hq:!1,amount:1},{id:22501,hq:!1,amount:2},{id:22502,hq:!1,amount:3}]);m(S,t)}else if(V.checked){const t=e.kdocsUploadV2({name:"测试用数据",returnTime:Math.floor(Date.now()/1e3),registerTime:Math.floor(Date.now()/1e3)-3600,rating:1,dests:[1,2,3],parts:[1,2,3,4],rank:1,items:[{id:22500,amount:1,hq:!1,surveillance:0,retrieval:0,discoveryDesc:0,doubleDip:!1,isSecondDip:!1,fromTier3Pool:!1,destId:1,rating:1},{id:22501,amount:2,hq:!1,surveillance:1,retrieval:1,discoveryDesc:1,doubleDip:!0,isSecondDip:!1,fromTier3Pool:!0,destId:2,rating:2}]});m(S,t)}};function m(n,e){e.then(t=>{n.className="success",n.innerText="上传成功"}).catch(t=>{console.log(t),n.className="fail",n.innerText=t.toString()})}document.getElementById("apply-cfg").onclick=n=>{oe({webhook:E.value,token:D.value,revision:U.checked?1:2,consent_analysis:B.checked}),l=q(),H.classList.add("hide")};document.getElementById("setting").onclick=n=>{H.classList.toggle("hide"),E.value=l.webhook,D.value=l.token,B.checked=l.consent_analysis===!0,U.checked=l.revision===1,V.checked=l.revision===2,S.innerText=""};ye.init(g);fe.init(g).then(()=>{console.log("PacketBasedCounter initialized"),M=!0});g.Start();</script>
    <style rel="stylesheet" crossorigin>.app{font-family:Helvetica,Segoe UI,PingFang SC,Helvetica Neue,Source Han Sans,思源黑体,Noto Sans,Microsoft Yahei,微软雅黑,Arial,sans-serif;font-size:14px;color:#fff;text-shadow:.5px .5px 2px #aa8422,-.5px .5px 2px #aa8422,.5px -.5px 2px #aa8422,-.5px -.5px 2px #aa8422;-webkit-user-select:none;user-select:none}a{text-decoration:none;color:#fff}.hide{display:none!important}.value{cursor:pointer}.fail{text-shadow:.5px .5px 2px #FF5A2B,-.5px .5px 2px #FF5A2B,.5px -.5px 2px #FF5A2B,-.5px -.5px 2px #FF5A2B}.success{text-shadow:.5px .5px 2px #7BC431,-.5px .5px 2px #7BC431,.5px -.5px 2px #7BC431,-.5px -.5px 2px #7BC431}a.button,button,input{background:none;border:0px solid #aa8422;border-radius:4px;box-shadow:.25px .25px 2px #aa8422,-.25px .25px 2px #aa8422,.25px -.25px 2px #aa8422,-.25px -.25px 2px #aa8422;color:#aa8422;text-shadow:none;background:#fff}a.button,button{cursor:pointer;padding:0 5px;margin:4px 3px}input{padding:3px 5px;margin:4px 3px}</style>
  </head>
  <body>
    <div class="app" id="app">
      <div>总收益：<span class="value" id="total-value">0</span> <button id="setting">设置</button><button href="#" id="close">隐藏</button></div>
      <div class="config hide" id="config">
        <div>
          <label for="webhook">Webhook:</label>
          <input type="text" id="webhook"/>
        </div>
        <div>
          <label for="token">凭证:</label>
          <input type="text" id="token"/>
        </div>
        <div>
          <label for="revision">数据版本:</label>
          <input type="radio" name="revision" value="1" id="revision-1" /><label for="revision-1">简要</label>
          <input type="radio" name="revision" value="2" id="revision-2" /><label for="revision-2">详细</label>
        </div>
        <div>
          <label for="consent_analysis">上报分析数据:</label>
          <input type="checkbox" id="consent_analysis" checked/>
        </div>
        <div class="btn">
          <a class="button" href="https://ffxiv.cyou/pages/submarine/" target="_blank">查看帮助</a>
          <button id="test-cfg">测试配置</button>
          <button id="apply-cfg">应用</button></div>
        <div id="test-output"></div>
      </div>
      <div id="item-list"></div>
      <div id="output" class="output"></div>
    </div>
  </body>
</html>
