<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>潜艇收益计算器</title>
    <script type="module" crossorigin>var q=Object.defineProperty;var M=(n,e,r)=>e in n?q(n,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):n[e]=r;var u=(n,e,r)=>M(n,typeof e!="symbol"?e+"":e,r);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))l(t);new MutationObserver(t=>{for(const i of t)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&l(s)}).observe(document,{childList:!0,subtree:!0});function r(t){const i={};return t.integrity&&(i.integrity=t.integrity),t.referrerPolicy&&(i.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?i.credentials="include":t.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function l(t){if(t.ep)return;t.ep=!0;const i=r(t);fetch(t.href,i)}})();(function(){let n=/[\?&]OVERLAY_WS=([^&]+)/.exec(location.href),e=null,r=[],l=0,t={},i={},s=null,f=!1;if(n){let o=function(){e=new WebSocket(n[1]),e.addEventListener("error",a=>{console.error(a)}),e.addEventListener("open",()=>{console.log("Connected!");let a=r;r=null;for(let c of a)s(c)}),e.addEventListener("message",a=>{try{a=JSON.parse(a.data)}catch{console.error("Invalid message received: ",a);return}a.rseq!==void 0&&t[a.rseq]?(t[a.rseq](a),delete t[a.rseq]):m(a)}),e.addEventListener("close",()=>{r=[],console.log("Trying to reconnect..."),setTimeout(()=>{o()},300)})};var L=o;s=a=>{r?r.push(a):e.send(JSON.stringify(a))},o()}else{let o=function(){if(!window.OverlayPluginApi||!window.OverlayPluginApi.ready){setTimeout(o,300);return}let a=r;r=null,window.__OverlayCallback=m;for(let[c,d]of a)s(c,d)};var k=o;s=(a,c)=>{r?r.push([a,c]):OverlayPluginApi.callHandler(JSON.stringify(a),c)},o()}function m(o){if(i[o.type])for(let a of i[o.type])a(o)}window.dispatchOverlayEvent=m,window.addOverlayListener=(o,a)=>{f&&i[o]&&console.warn(`A new listener for ${o} has been registered after event transmission has already begun.
Some events might have been missed and no cached values will be transmitted.
Please register your listeners before calling startOverlayEvents().`),i[o]||(i[o]=[]),i[o].push(a)},window.removeOverlayListener=(o,a)=>{if(i[o]){let c=i[o],d=c.indexOf(a);d>-1&&c.splice(d,1)}},window.callOverlayHandler=o=>{let a;return e?(o.rseq=l++,a=new Promise(c=>{t[o.rseq]=c}),s(o)):a=new Promise(c=>{s(o,d=>{c(d==null?null:JSON.parse(d))})}),a},window.startOverlayEvents=()=>{f=!1,s({call:"subscribe",events:Object.keys(i)})}})();class T{constructor(e){u(this,"array");u(this,"capacity");u(this,"_front");u(this,"_back");u(this,"_full");this.array=[],this.capacity=e,this._front=0,this._back=0,this._full=!1}push_back(e){this.array.length<this.capacity?this.array.push(e):this.array[this._back]=e,this._back=(this._back+1)%this.capacity,this._full&&(this._front=this._back),this._back==this._front&&(this._full=!0)}front(){if(!(this._front==this._back&&!this._full))return this.array[this._front]}pop_front(){if(!(this._front==this._back&&!this._full)){var e=this.array[this._front];return this._front=(this._front+1)%this.capacity,this._full&&(this._full=!1),e}}empty(){return!this._full&&this._front===this._back}}class p{constructor(e,r,l){u(this,"id");u(this,"amount");u(this,"hq");this.id=e,this.hq=r,this.amount=l}static parse(e,r){return new p(e%1e6,e>=1e6,r)}}class x{constructor(e,r){u(this,"itemID");u(this,"amount");u(this,"date");this.itemID=e,this.amount=r,this.date=Date.now()}}class B{constructor(e){u(this,"buffer");u(this,"callback");this.buffer=new T(100),this.callback=e}parseLogLines(e){if(!(e.length<1))switch(e[0]){case"00":this.parseLogLine(e[2],e[3],e[4]);break;case"41":this.parseSystemLogMessage(e[2],e[3],e[4],e[5],e[6]);break}}parseLogLine(e,r,l){if(!(e!=="0039"&&r!=="")){var t=/接受了“(.+)”探索完成的报告。/g,i=t.exec(l);if(!(!i||i.length<1)){var s=i[1];this.queueCleanup(Date.now()),setTimeout(()=>{this.setShipName(s)},1e3)}}}parseSystemLogMessage(e,r,l,t,i){if(r==="2EF"){var s=parseInt(t,16),f=parseInt(i,16);this.enqueueItem(s,f)}}setShipName(e){for(var r=new Map;!this.buffer.empty();){var l=this.buffer.front();if(this.buffer.pop_front(),!!l){var t=l.itemID,i=l.amount;if(r.has(t)){var s=r.get(t);s!=null&&(i+=s)}r.set(t,i)}}let f=[];r.forEach((m,L)=>{var k=p.parse(L,m);f.push(k)}),this.callback(e,f)}enqueueItem(e,r){var l=new x(e,r);this.queueCleanup(l.date),this.buffer.push_back(l)}queueCleanup(e){for(;!this.buffer.empty();){var r=this.buffer.front();if(!r)break;if(e-r.date>5e3)this.buffer.pop_front();else break}}}const C=[{Id:22500,Name:"沉船戒指",PriceLow:8e3,PriceMid:3e4},{Id:22501,Name:"沉船手镯",PriceLow:9e3,PriceMid:3e4},{Id:22502,Name:"沉船耳饰",PriceLow:1e4,PriceMid:3e4},{Id:22503,Name:"沉船项链",PriceLow:13e3,PriceMid:3e4},{Id:22504,Name:"上等沉船戒指",PriceLow:27e3,PriceMid:9e4},{Id:22505,Name:"上等沉船手镯",PriceLow:28500,PriceMid:9e4},{Id:22506,Name:"上等沉船耳饰",PriceLow:3e4,PriceMid:9e4},{Id:22507,Name:"上等沉船项链",PriceLow:34500,PriceMid:9e4}];function D(n,e={}){return console.log("Fetching",n,e),callOverlayHandler({call:"Fetch",resource:n,options:e})}function A(n,e,r){return D(n,{method:"POST",headers:{"Content-Type":"application/json","AirScript-Token":e},body:JSON.stringify({Context:{argv:r}})})}const P="ship_config",I={webhook:"",token:""};function O(){var n=localStorage.getItem(P);if(n===null)return I;try{return JSON.parse(n)}catch{return I}}function J(n,e){localStorage.setItem(P,JSON.stringify({webhook:n,token:e}))}var w=new Map;C.forEach(n=>{w.set(n.Id,n)});var g=document.getElementById("item-list"),F=document.getElementById("total-value"),N=document.getElementById("app"),E=document.getElementById("config"),y=0,h=O(),R=new B((n,e)=>{if(e.length!==0){var r=document.createElement("div");g.appendChild(r);var l=0;e.forEach(t=>{var i=w.get(t.id);if(i!==void 0){var s=document.createElement("div");s.innerText=i.Name+" ×"+t.amount,g.appendChild(s),l+=(t.hq?i.PriceMid:i.PriceLow)*t.amount}}),r.innerText=n+": "+l.toString(),y+=l,F.innerText=y.toString(),N.classList.remove("hide"),h.webhook&&h.token&&S(h.webhook,h.token,n,e).then(t=>console.log(t)).catch(t=>console.error(t))}});document.getElementById("close").onclick=n=>{N.classList.add("hide"),g.innerText="",y=0,n.preventDefault()};addOverlayListener("LogLine",n=>{R.parseLogLines(n.line)});var b=document.getElementById("webhook"),_=document.getElementById("token"),v=document.getElementById("test-output");function S(n,e,r,l){return A(n,e,{data:l.map(t=>{var i=w.get(t.id);if(i!=null){var s=t.hq?i.PriceMid:i.PriceLow;return{fields:{潜艇名:r,物品名:i.Name,数量:t.amount,单价:s,总价:s*t.amount}}}}).filter(t=>t!==void 0)})}document.getElementById("test-cfg").onclick=n=>{S(b.value,_.value,"测试用数据",[new p(22500,!1,1),new p(22501,!1,2),new p(22502,!1,3)]).then(e=>{console.log(e),v.className=e.ok?"success":"fail",v.innerText=e.body}).catch(e=>v.innerText=e.toString())};document.getElementById("apply-cfg").onclick=n=>{J(b.value,_.value),h=O(),E.classList.add("hide")};document.getElementById("setting").onclick=n=>{E.classList.toggle("hide"),b.value=h.webhook,_.value=h.token,v.innerText=""};startOverlayEvents();</script>
    <style rel="stylesheet" crossorigin>.app{font-family:Helvetica,Segoe UI,PingFang SC,Helvetica Neue,Source Han Sans,思源黑体,Noto Sans,Microsoft Yahei,微软雅黑,Arial,sans-serif;font-size:14px;color:#fff;text-shadow:.5px .5px 2px #aa8422,-.5px .5px 2px #aa8422,.5px -.5px 2px #aa8422,-.5px -.5px 2px #aa8422;-webkit-user-select:none;user-select:none}a{text-decoration:none;color:#fff}.hide{display:none!important}.value{cursor:pointer}.fail{text-shadow:.5px .5px 2px #FF5A2B,-.5px .5px 2px #FF5A2B,.5px -.5px 2px #FF5A2B,-.5px -.5px 2px #FF5A2B}.success{text-shadow:.5px .5px 2px #7BC431,-.5px .5px 2px #7BC431,.5px -.5px 2px #7BC431,-.5px -.5px 2px #7BC431}a.button,button,input{background:none;border:0px solid #aa8422;border-radius:4px;box-shadow:.25px .25px 2px #aa8422,-.25px .25px 2px #aa8422,.25px -.25px 2px #aa8422,-.25px -.25px 2px #aa8422;color:#aa8422;text-shadow:none}a.button,button{cursor:pointer;padding:0 5px;margin:4px 3px}input{padding:3px 5px;margin:4px 3px}</style>
  </head>
  <body>
    <div class="app" id="app">
      <div>总收益：<span class="value" id="total-value">0</span> <button id="setting">设置</button><button href="#" id="close">隐藏</button></div>
      <div class="config hide" id="config">
        <div>
          <label for="webhook">Webhook:</label>
          <input type="text" id="webhook"/>
        </div>
        <div>
          <label for="token">凭证:</label>
          <input type="text" id="token"/>
        </div>
        <div class="btn">
          <a class="button" href="https://ffxiv.cyou/pages/submarine/" target="_blank">查看帮助</a>
          <button id="test-cfg">测试配置</button>
          <button id="apply-cfg">应用</button></div>
        <div id="test-output"></div>
      </div>
      <div id="item-list"></div>
    </div>
  </body>
</html>
