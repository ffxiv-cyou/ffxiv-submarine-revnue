<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>潜艇收益计算器</title>
    <script type="module" crossorigin>var M=Object.defineProperty;var T=(n,e,t)=>e in n?M(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var f=(n,e,t)=>T(n,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))l(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&l(s)}).observe(document,{childList:!0,subtree:!0});function t(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function l(r){if(r.ep)return;r.ep=!0;const i=t(r);fetch(r.href,i)}})();(function(){let n=/[\?&]OVERLAY_WS=([^&]+)/.exec(location.href),e=null,t=[],l=0,r={},i={},s=null,c=!1;if(n){let o=function(){e=new WebSocket(n[1]),e.addEventListener("error",a=>{console.error(a)}),e.addEventListener("open",()=>{console.log("Connected!");let a=t;t=null;for(let u of a)s(u)}),e.addEventListener("message",a=>{try{a=JSON.parse(a.data)}catch{console.error("Invalid message received: ",a);return}a.rseq!==void 0&&r[a.rseq]?(r[a.rseq](a),delete r[a.rseq]):d(a)}),e.addEventListener("close",()=>{t=[],console.log("Trying to reconnect..."),setTimeout(()=>{o()},300)})};var v=o;s=a=>{t?t.push(a):e.send(JSON.stringify(a))},o()}else{let o=function(){if(!window.OverlayPluginApi||!window.OverlayPluginApi.ready){setTimeout(o,300);return}let a=t;t=null,window.__OverlayCallback=d;for(let[u,h]of a)s(u,h)};var I=o;s=(a,u)=>{t?t.push([a,u]):OverlayPluginApi.callHandler(JSON.stringify(a),u)},o()}function d(o){if(i[o.type])for(let a of i[o.type])a(o)}window.dispatchOverlayEvent=d,window.addOverlayListener=(o,a)=>{c&&i[o]&&console.warn(`A new listener for ${o} has been registered after event transmission has already begun.
Some events might have been missed and no cached values will be transmitted.
Please register your listeners before calling startOverlayEvents().`),i[o]||(i[o]=[]),i[o].push(a)},window.removeOverlayListener=(o,a)=>{if(i[o]){let u=i[o],h=u.indexOf(a);h>-1&&u.splice(h,1)}},window.callOverlayHandler=o=>{let a;return e?(o.rseq=l++,a=new Promise(u=>{r[o.rseq]=u}),s(o)):a=new Promise(u=>{s(o,h=>{u(h==null?null:JSON.parse(h))})}),a},window.startOverlayEvents=()=>{c=!1,s({call:"subscribe",events:Object.keys(i)})}})();class x{constructor(e){f(this,"array");f(this,"capacity");f(this,"_front");f(this,"_back");f(this,"_full");this.array=[],this.capacity=e,this._front=0,this._back=0,this._full=!1}push_back(e){this.array.length<this.capacity?this.array.push(e):this.array[this._back]=e,this._back=(this._back+1)%this.capacity,this._full&&(this._front=this._back),this._back==this._front&&(this._full=!0)}front(){if(!(this._front==this._back&&!this._full))return this.array[this._front]}pop_front(){if(!(this._front==this._back&&!this._full)){var e=this.array[this._front];return this._front=(this._front+1)%this.capacity,this._full&&(this._full=!1),e}}empty(){return!this._full&&this._front===this._back}}class m{constructor(e,t,l){f(this,"id");f(this,"amount");f(this,"hq");this.id=e,this.hq=t,this.amount=l}static parse(e,t){return new m(e%1e6,e>=1e6,t)}}class B{constructor(e,t){f(this,"itemID");f(this,"amount");f(this,"date");this.itemID=e,this.amount=t,this.date=Date.now()}}class C{constructor(e){f(this,"buffer");f(this,"callback");this.buffer=new x(100),this.callback=e}parseLogLines(e){if(!(e.length<1))switch(e[0]){case"00":this.parseLogLine(e[2],e[3],e[4]);break;case"41":this.parseSystemLogMessage(e[2],e[3],e[4],e[5],e[6]);break}}parseLogLine(e,t,l){if(!(e!=="0039"&&t!=="")){var r=/接受了“(.+)”探索完成的报告。/g,i=r.exec(l);if(!(!i||i.length<1)){var s=i[1];this.queueCleanup(Date.now()),setTimeout(()=>{this.setShipName(s)},1e3)}}}parseSystemLogMessage(e,t,l,r,i){if(t==="2EF"){var s=parseInt(r,16),c=parseInt(i,16);this.enqueueItem(s,c)}}setShipName(e){for(var t=new Map;!this.buffer.empty();){var l=this.buffer.front();if(this.buffer.pop_front(),!!l){var r=l.itemID,i=l.amount;if(t.has(r)){var s=t.get(r);s!=null&&(i+=s)}t.set(r,i)}}let c=[];t.forEach((d,v)=>{var I=m.parse(v,d);c.push(I)}),this.callback(e,c)}enqueueItem(e,t){var l=new B(e,t);this.queueCleanup(l.date),this.buffer.push_back(l)}queueCleanup(e){for(;!this.buffer.empty();){var t=this.buffer.front();if(!t)break;if(e-t.date>5e3)this.buffer.pop_front();else break}}}const D=[{Id:22500,Name:"沉船戒指",PriceLow:8e3,PriceMid:3e4},{Id:22501,Name:"沉船手镯",PriceLow:9e3,PriceMid:3e4},{Id:22502,Name:"沉船耳饰",PriceLow:1e4,PriceMid:3e4},{Id:22503,Name:"沉船项链",PriceLow:13e3,PriceMid:3e4},{Id:22504,Name:"上等沉船戒指",PriceLow:27e3,PriceMid:9e4},{Id:22505,Name:"上等沉船手镯",PriceLow:28500,PriceMid:9e4},{Id:22506,Name:"上等沉船耳饰",PriceLow:3e4,PriceMid:9e4},{Id:22507,Name:"上等沉船项链",PriceLow:34500,PriceMid:9e4}];function J(n,e={}){return console.log("Fetching",n,e),callOverlayHandler({call:"Fetch",resource:n,options:e})}function A(n,e,t){return J(n,{method:"POST",headers:{"Content-Type":"application/json","AirScript-Token":e},body:JSON.stringify({Context:{argv:t}})})}const O="ship_config",N={webhook:"",token:""};function P(){var n=localStorage.getItem(O);if(n===null)return N;try{return JSON.parse(n)}catch{return N}}function F(n,e){localStorage.setItem(O,JSON.stringify({webhook:n,token:e}))}var _=new Map;D.forEach(n=>{_.set(n.Id,n)});var w=document.getElementById("item-list"),R=document.getElementById("total-value"),E=document.getElementById("app"),S=document.getElementById("config"),y=document.getElementById("output"),b=0,p=P(),H=new C((n,e)=>{if(e.length!==0){var t=document.createElement("div");w.appendChild(t);var l=0;e.forEach(r=>{var i=_.get(r.id);if(i!==void 0){var s=document.createElement("div");s.innerText=i.Name+" ×"+r.amount,w.appendChild(s),l+=(r.hq?i.PriceMid:i.PriceLow)*r.amount}}),t.innerText=n+": "+l.toString(),b+=l,R.innerText=b.toString(),E.classList.remove("hide"),p.webhook&&p.token&&q(p.webhook,p.token,n,e).then(r=>{y.className="success",y.innerText="上传成功"}).catch(r=>{y.className="fail",y.innerText=r.toString()})}});document.getElementById("close").onclick=n=>{E.classList.add("hide"),w.innerText="",b=0,n.preventDefault()};addOverlayListener("LogLine",n=>{H.parseLogLines(n.line)});var L=document.getElementById("webhook"),k=document.getElementById("token"),g=document.getElementById("test-output");async function q(n,e,t,l){let r=await A(n,e,{data:l.map(c=>{var d=_.get(c.id);if(d!=null){var v=c.hq?d.PriceMid:d.PriceLow;return{fields:{潜艇名:t,物品名:d.Name,数量:c.amount,单价:v,总价:v*c.amount}}}}).filter(c=>c!==void 0)});var i=r.body,s=JSON.parse(i);if(r.ok)return s;throw new Error(s.error||s.msg||s.reason||s.result||i)}document.getElementById("test-cfg").onclick=n=>{q(L.value,k.value,"测试用数据",[new m(22500,!1,1),new m(22501,!1,2),new m(22502,!1,3)]).then(e=>{console.log(e),g.className="success",g.innerText="上传成功"}).catch(e=>{g.innerText=e.toString(),g.className="fail"})};document.getElementById("apply-cfg").onclick=n=>{F(L.value,k.value),p=P(),S.classList.add("hide")};document.getElementById("setting").onclick=n=>{S.classList.toggle("hide"),L.value=p.webhook,k.value=p.token,g.innerText=""};startOverlayEvents();</script>
    <style rel="stylesheet" crossorigin>.app{font-family:Helvetica,Segoe UI,PingFang SC,Helvetica Neue,Source Han Sans,思源黑体,Noto Sans,Microsoft Yahei,微软雅黑,Arial,sans-serif;font-size:14px;color:#fff;text-shadow:.5px .5px 2px #aa8422,-.5px .5px 2px #aa8422,.5px -.5px 2px #aa8422,-.5px -.5px 2px #aa8422;-webkit-user-select:none;user-select:none}a{text-decoration:none;color:#fff}.hide{display:none!important}.value{cursor:pointer}.fail{text-shadow:.5px .5px 2px #FF5A2B,-.5px .5px 2px #FF5A2B,.5px -.5px 2px #FF5A2B,-.5px -.5px 2px #FF5A2B}.success{text-shadow:.5px .5px 2px #7BC431,-.5px .5px 2px #7BC431,.5px -.5px 2px #7BC431,-.5px -.5px 2px #7BC431}a.button,button,input{background:none;border:0px solid #aa8422;border-radius:4px;box-shadow:.25px .25px 2px #aa8422,-.25px .25px 2px #aa8422,.25px -.25px 2px #aa8422,-.25px -.25px 2px #aa8422;color:#aa8422;text-shadow:none;background:#fff}a.button,button{cursor:pointer;padding:0 5px;margin:4px 3px}input{padding:3px 5px;margin:4px 3px}</style>
  </head>
  <body>
    <div class="app" id="app">
      <div>总收益：<span class="value" id="total-value">0</span> <button id="setting">设置</button><button href="#" id="close">隐藏</button></div>
      <div class="config hide" id="config">
        <div>
          <label for="webhook">Webhook:</label>
          <input type="text" id="webhook"/>
        </div>
        <div>
          <label for="token">凭证:</label>
          <input type="text" id="token"/>
        </div>
        <div class="btn">
          <a class="button" href="https://ffxiv.cyou/pages/submarine/" target="_blank">查看帮助</a>
          <button id="test-cfg">测试配置</button>
          <button id="apply-cfg">应用</button></div>
        <div id="test-output"></div>
      </div>
      <div id="item-list"></div>
      <div id="output" class="output"></div>
    </div>
  </body>
</html>
