<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>潜艇收益计算器</title>
    <script type="module" crossorigin>
var g=Object.defineProperty;var L=(o,e,t)=>e in o?g(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var f=(o,e,t)=>(L(o,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const l of i.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function t(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(r){if(r.ep)return;r.ep=!0;const i=t(r);fetch(r.href,i)}})();(function(){let o=/[\?&]OVERLAY_WS=([^&]+)/.exec(location.href),e=null,t=[],n=0,r={},i={},l=null,u=!1;if(o){let a=function(){e=new WebSocket(o[1]),e.addEventListener("error",s=>{console.error(s)}),e.addEventListener("open",()=>{console.log("Connected!");let s=t;t=null;for(let c of s)l(c)}),e.addEventListener("message",s=>{try{s=JSON.parse(s.data)}catch{console.error("Invalid message received: ",s);return}s.rseq!==void 0&&r[s.rseq]?(r[s.rseq](s),delete r[s.rseq]):h(s)}),e.addEventListener("close",()=>{t=[],console.log("Trying to reconnect..."),setTimeout(()=>{a()},300)})};var w=a;l=s=>{t?t.push(s):e.send(JSON.stringify(s))},a()}else{let a=function(){if(!window.OverlayPluginApi||!window.OverlayPluginApi.ready){setTimeout(a,300);return}let s=t;t=null,window.__OverlayCallback=h;for(let[c,d]of s)l(c,d)};var b=a;l=(s,c)=>{t?t.push([s,c]):OverlayPluginApi.callHandler(JSON.stringify(s),c)},a()}function h(a){if(i[a.type])for(let s of i[a.type])s(a)}window.dispatchOverlayEvent=h,window.addOverlayListener=(a,s)=>{u&&i[a]&&console.warn(`A new listener for ${a} has been registered after event transmission has already begun.
Some events might have been missed and no cached values will be transmitted.
Please register your listeners before calling startOverlayEvents().`),i[a]||(i[a]=[]),i[a].push(s)},window.removeOverlayListener=(a,s)=>{if(i[a]){let c=i[a],d=c.indexOf(s);d>-1&&c.splice(d,1)}},window.callOverlayHandler=a=>{let s;return e?(a.rseq=n++,s=new Promise(c=>{r[a.rseq]=c}),l(a)):s=new Promise(c=>{l(a,d=>{c(d==null?null:JSON.parse(d))})}),s},window.startOverlayEvents=()=>{u=!1,l({call:"subscribe",events:Object.keys(i)})}})();class _{constructor(e){f(this,"array");f(this,"capacity");f(this,"_front");f(this,"_back");f(this,"_full");this.array=[],this.capacity=e,this._front=0,this._back=0,this._full=!1}push_back(e){this.array.length<this.capacity?this.array.push(e):this.array[this._back]=e,this._back=(this._back+1)%this.capacity,this._full&&(this._front=this._back),this._back==this._front&&(this._full=!0)}front(){if(!(this._front==this._back&&!this._full))return this.array[this._front]}pop_front(){if(!(this._front==this._back&&!this._full)){var e=this.array[this._front];return this._front=(this._front+1)%this.capacity,this._full&&(this._full=!1),e}}empty(){return!this._full&&this._front===this._back}}class p{constructor(e,t,n){f(this,"id");f(this,"amount");f(this,"hq");this.id=e,this.hq=t,this.amount=n}static parse(e,t){return new p(e%1e6,e>=1e6,t)}}class P{constructor(e,t){f(this,"itemID");f(this,"amount");f(this,"date");this.itemID=e,this.amount=t,this.date=Date.now()}}class I{constructor(e){f(this,"buffer");f(this,"callback");this.buffer=new _(100),this.callback=e}parseLogLines(e){if(!(e.length<1))switch(e[0]){case"00":this.parseLogLine(e[2],e[3],e[4]);break;case"41":this.parseSystemLogMessage(e[2],e[3],e[4],e[5],e[6]);break}}parseLogLine(e,t,n){if(!(e!=="0039"&&t!=="")){var r=/接受了“(.+)”探索完成的报告。/g,i=r.exec(n);if(!(!i||i.length<1)){var l=i[1];this.setShipName(l)}}}parseSystemLogMessage(e,t,n,r,i){if(t==="2EF"){var l=parseInt(r,16),u=parseInt(i,16);this.enqueueItem(l,u)}}setShipName(e){for(var t=new Map;!this.buffer.empty();){var n=this.buffer.front();if(this.buffer.pop_front(),!!n){var r=n.itemID,i=n.amount;if(t.has(r)){var l=t.get(r);l!=null&&(i+=l)}t.set(r,i)}}let u=[];t.forEach((h,w)=>{var b=p.parse(w,h);u.push(b)}),this.callback(e,u)}enqueueItem(e,t){var n=new P(e,t);for(console.log(n);!this.buffer.empty();){var r=this.buffer.front();if(!r)break;if(n.date-r.date>5e3)this.buffer.pop_front();else break}this.buffer.push_back(n)}}const O=[{Id:22500,Name:"沉船戒指",PriceLow:8e3,PriceMid:3e4},{Id:22501,Name:"沉船手镯",PriceLow:9e3,PriceMid:3e4},{Id:22502,Name:"沉船耳饰",PriceLow:1e4,PriceMid:3e4},{Id:22503,Name:"沉船项链",PriceLow:13e3,PriceMid:3e4},{Id:22504,Name:"上等沉船戒指",PriceLow:27e3,PriceMid:9e4},{Id:22505,Name:"上等沉船手镯",PriceLow:28500,PriceMid:9e4},{Id:22506,Name:"上等沉船耳饰",PriceLow:3e4,PriceMid:9e4},{Id:22507,Name:"上等沉船项链",PriceLow:34500,PriceMid:9e4}];var v=new Map;O.forEach(o=>{v.set(o.Id,o)});var N=document.getElementById("ship-name"),m=document.getElementById("item-list"),E=document.getElementById("total-value"),y=document.getElementById("app"),k=new I((o,e)=>{N.innerText=o,m.innerHTML="";var t=0;e.forEach(n=>{var r=v.get(n.id);if(r!==void 0){var i=document.createElement("div");i.innerText=r.Name+" ×"+n.amount,m.appendChild(i),t+=(n.hq?r.PriceMid:r.PriceLow)*n.amount}}),E.innerText=t.toString(),y.classList.remove("hide")});document.getElementById("close").onclick=o=>{y.classList.add("hide"),o.preventDefault()};addOverlayListener("LogLine",o=>{k.parseLogLines(o.line)});startOverlayEvents();

</script>
    <style>
.app{font-family:Source Han Sans,\601d\6e90\9ed1\4f53,Noto Sans,Microsoft Yahei,\5fae\8f6f\96c5\9ed1,Arial,sans-serif;font-size:14px;color:#fff;text-shadow:.5px .5px 2px #aa8422,-.5px .5px 2px #aa8422,.5px -.5px 2px #aa8422,-.5px -.5px 2px #aa8422;user-select:none}a{text-decoration:none;color:#fff}.hide{display:none!important}.value{user-select:all!important}

</style>
  </head>
  <body>
    <div class="app" id="app">
      <div><span id="ship-name">潜艇收益计算器 | 点击右边关闭 </span><a href="#" id="close">&times;</a></div>
      <div>总价: <span class="value" id="total-value">0</span></div>
      <div id="item-list"></div>
    </div>
    
  </body>
</html>
